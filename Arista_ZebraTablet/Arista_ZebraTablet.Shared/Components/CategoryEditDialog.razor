@using Arista_ZebraTablet.Shared.Application.ViewModels

<ModalDialog
    Title="Edit Category"
    Actions="@actionBtns"
    OnActionClick="HandleActionClick"
>
    <ContentArea>
        <MudStack Spacing="2">
            <MudText Typo="Typo.body2">
                Update category for: <b>@(BarcodeItem?.Value)</b>
            </MudText>

            <MudSelect
                T="string"
                @ref="selectRef"
                @bind-Value="category"
                Label="Category"
                Variant="Variant.Outlined"
                Margin="Margin.Dense"
                Disabled="@isBusy"
                Required
            >
                @foreach (var category in DefaultCategories)
                {
                    <MudSelectItem Value="@category">@category</MudSelectItem>
                }
            </MudSelect>
        </MudStack>
    </ContentArea>

</ModalDialog>

@code {
    [CascadingParameter] private IMudDialogInstance MudDialog { get; set; } = default!;
    [Parameter] public ScanBarcodeItemViewModel BarcodeItem { get; set; } = default!;

    // Variable declaration & initialization
    private bool isBusy;
    private string category = string.Empty;
    private MudSelect<string>? selectRef;

    // Default categories
    private static readonly IReadOnlyList<string> DefaultCategories = new[]
    {
        "ASY", "PCA", "Serial Number", "MAC Address", "Deviation", "Unknown"
    };

    // Configure actions for ModalDialog (Cancel / Save)
    private readonly ModalDialog.DialogAction[] actionBtns =
    {
        ModalDialog.DialogAction.Cancel("Cancel"),
        ModalDialog.DialogAction.Ok(text: "Save", value: true, color: Color.Primary, variant: Variant.Filled)
    };

    protected override void OnParametersSet()
    {
        // local copy so Cancel won't mutate the original
        category = BarcodeItem?.Category ?? string.Empty;
    }

    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        if (firstRender && selectRef is not null)
        {
            // give focus to the select after render for better UX
            await selectRef.FocusAsync();
        }
    }

    /// <summary>
    /// Called *before* ModalDialog closes (per your ModalDialog.cs).
    /// We update the model on Save; Cancel does nothing.
    /// </summary>
    private async Task HandleActionClick(ModalDialog.DialogAction action)
    {
        if (action.CloseBehavior != ModalDialog.DialogCloseBehavior.Ok)
            return;

        try
        {
            isBusy = true;

            var selected = (category ?? string.Empty).Trim();
            BarcodeItem.Category = string.IsNullOrWhiteSpace(selected) ? "Unknown" : selected;

            // Your ModalDialog will close automatically after this callback
            // because action.CloseBehavior == Ok and ReturnActionAsResult = true.
            // The dialog result will carry 'action.Value' (true) as Data.
            // If you want to also pass the updated item, you can close manually instead:
            // MudDialog.Close(DialogResult.Ok(BarcodeItem));
            // and change the Save action to NoClose() in actionBtns.
        }
        finally
        {
            isBusy = false;
        }
    }
}
