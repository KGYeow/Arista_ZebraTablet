@page "/"

@using Arista_ZebraTablet.Shared.Application.Enums
@using Arista_ZebraTablet.Shared.Application.ViewModels

@inject IFormFactorService FormFactor
@inject IBarcodeDetectorService Detector
@inject IScannedBarcodeService ScannedBarcodeService

<PageTitle>Home | @AppConstant.AppTitle</PageTitle>

<MudContainer Class="py-6 overflow-auto d-flex flex-column gap-3" MaxWidth="MaxWidth.Large" Style="flex: 1 1 auto; min-height: 0;">
@* <MudContainer Class="py-6 overflow-auto" MaxWidth="MaxWidth.Large">
    <MudStack Class="h-100" Spacing="2" Style="flex: 1 1 auto; min-height: 0;"> *@
        <MudItem Class="position-sticky" Style="top: 24px;">
            <MudGrid Spacing="4" Justify="Justify.Center">
                <!-- Barcode Mode Toggle Button -->
                <MudItem xs="12" sm="4">
                    <MudToggleGroup T="BarcodeMode"
                                    @bind-Value="barcodeMode"
                                    SelectionMode="SelectionMode.SingleSelection"
                                    SelectedClass="bg-white"
                                    Color="Color.Inherit"
                                    Size="Size.Small"
                                    Class="mud-theme-primary"
                                    Outlined="false">
                        <MudToggleItem Text="Standard" Value="BarcodeMode.Standard" Class="ma-1 rounded" />
                        <MudToggleItem Text="Unique" Value="BarcodeMode.Unique" Class="ma-1 rounded" />
                    </MudToggleGroup>
                </MudItem>

                <MudItem xs="12">
                    <MudPaper Class="pa-5" Elevation="0">
                        <MudStack Spacing="3" AlignItems="AlignItems.Center" Justify="Justify.SpaceBetween">
                            <!-- Instruction Section -->
                            <MudStack Spacing="2" AlignItems="AlignItems.Center">
                                <MudText Typo="Typo.h5" Class="fw-bold">Scan Barcodes</MudText>
                                <MudText Typo="Typo.body2" Class="text-center">
                                    Upload one or more images and tap <b>Detect Barcode</b> to begin.<br />
                                </MudText>
                            </MudStack>

                            <!-- Detect Barcodes Button -->
                            <MudStack Row AlignItems="AlignItems.Center" Justify="Justify.Center" Spacing="2">
                                <MudButton Variant="Variant.Filled"
                                           Color="Color.Primary"
                                           StartIcon="material-symbols-rounded/scan"
                                           Disabled="@(!uploadedImageFiles.Any() || isBusy)"
                                           DropShadow="false"
                                           Size="Size.Large"
                                           Class="px-6"
                                           OnClick="DecodeBarcodes">
                                    @(isBusy ? "Processing..." : "Detect Barcodes")
                                </MudButton>
                            </MudStack>

                            <!-- Helpful reason when disabled -->
                            @if (!uploadedImageFiles.Any() && !isBusy)
                            {
                                <MudText Typo="Typo.caption" Align="Align.Center" Class="text-center">
                                    Add at least one image to enable barcode detection.
                                </MudText>
                            }
                        </MudStack>

                        <!-- Barcode Decoding Progress -->
                        <MudCollapse Class="w-100" Expanded="isBusy">
                            <MudStack Class="mt-3" Spacing="0" AlignItems="AlignItems.Center">
                                <MudProgressLinear Value="@decodeProgress" Color="Color.Info" Rounded />
                                <MudText Typo="Typo.caption" Align="Align.Center" Class="mt-1">
                                    Detecting barcodes... @decodeProgress%
                                </MudText>
                            </MudStack>
                        </MudCollapse>
                    </MudPaper>
                </MudItem>
            </MudGrid>
        </MudItem>

        @if (isUploadingImg || isSaving)
        {
            <!-- Uploading Images Progress -->
            <MudCollapse Class="w-100" Expanded="@(isUploadingImg || isSaving)">
                <MudStack Spacing="0" AlignItems="AlignItems.Center">
                    <MudProgressCircular Color="Color.Primary"
                                         StrokeWidth="4"
                                         Size="Size.Medium"
                                         Rounded
                                         Indeterminate />
                    <MudText Typo="Typo.caption" Align="Align.Center" Class="mt-1">
                        @(isUploadingImg ? $"Uploading... {uploadImgProgress}%" : (isSaving ? "Submitting Results..." : "Uploading images..."))
                    </MudText>
                </MudStack>
            </MudCollapse>
        }

        <MudItem Class="overflow-auto" Style="flex: 1 1 auto; min-height: 0; -webkit-overflow-scrolling: touch">
            @if (uploadedImageFiles.Any())
            {
                <!-- Uploaded Image File Preview Cards -->
                <MudStack Class="h-100 px-0" Spacing="2">
                    @foreach (var img in uploadedImageFiles)
                    {
                        <!-- Image File Preview Card -->
                        <MudCard Elevation="0">
                            <MudCardContent Class="pa-3">
                                <MudStack Row AlignItems="AlignItems.Center" Spacing="1">
                                    <!-- Thumbnail Image -->
                                    @if (!string.IsNullOrWhiteSpace(img.PreviewDataUrl))
                                    {
                                        <MudLink OnClick="() => OpenPreviewImgDialogAsync(img.Id)">
                                            <MudImage Src="@img.PreviewDataUrl"
                                                      Class="rounded-lg me-3"
                                                      Width="56"
                                                      Height="56"
                                                      ObjectFit="ObjectFit.Cover" />
                                        </MudLink>
                                    }
                                    else
                                    {
                                        <MudAvatar Class="me-3" Size="Size.Large" Color="Color.Default" Rounded>
                                            <MudIcon Icon="@Icons.Material.Rounded.Image" />
                                        </MudAvatar>
                                    }

                                    <!-- Image Information -->
                                    <MudStack Spacing="0" Class="overflow-hidden">
                                        <MudText Typo="Typo.subtitle2" Style="white-space:nowrap; overflow:hidden; text-overflow:ellipsis;">
                                            @img.FileName
                                        </MudText>

                                        <MudStack Row Spacing="0">
                                            <MudChip T="ImgItemViewModel" Color="@ImageFileStateColor(img.State)" Size="Size.Small">
                                                @ImageFileStateLabel(img.State)
                                            </MudChip>

                                            @if (img.State == FileState.Done)
                                            {
                                                <MudChip T="ImgItemViewModel"
                                                         Color="Color.Primary"
                                                         Size="Size.Small"
                                                         Icon="@(IsExpanded(img.Id) && img.DetectResult.Barcodes.Count > 0 ? @Icons.Material.Rounded.Visibility : @Icons.Material.Rounded.VisibilityOff)"
                                                         OnClick="@(() => ToggleResults(img.Id))">
                                                    @($"{img.DetectResult!.Barcodes.Count} barcode(s)")
                                                </MudChip>
                                            }
                                        </MudStack>
                                    </MudStack>

                                    <MudSpacer />

                                    <!-- Delete Image Button -->
                                    <MudTooltip Text="Delete" Placement="Placement.Left" Delay="250" Arrow>
                                        <MudIconButton Icon="@Icons.Material.Filled.Delete"
                                                       Color="Color.Error"
                                                       Size="Size.Small"
                                                       Disabled="@isBusy"
                                                       OnClick="@(() => DeleteUploadedImgConfirmationAsync(img))" />
                                    </MudTooltip>
                                </MudStack>

                                @if (img.State == FileState.Error && !string.IsNullOrWhiteSpace(img.ErrorMessage))
                                {
                                    <MudAlert Class="mt-2" Severity="Severity.Error" Dense NoIcon>
                                        <MudText Typo="Typo.caption">@img.ErrorMessage</MudText>
                                    </MudAlert>
                                }

                                <!-- Collapsible Detected Barcode Results inside the Card -->
                                <MudCollapse Expanded="IsExpanded(img.Id) && img.DetectResult.Barcodes.Count > 0">
                                    @if (img.State == FileState.Done)
                                    {
                                        <MudSimpleTable Class="mt-3" Dense Bordered Hover Outlined>
                                            <tbody>
                                                @foreach (var detectedBarcode in img.DetectResult.Barcodes)
                                                {
                                                    <tr>
                                                        <td>@detectedBarcode.Category</td>
                                                        <td>@detectedBarcode.Value</td>
                                                        <td style="width: 0;">
                                                            <MudStack Row Spacing="1" AlignItems="AlignItems.Center">
                                                                <!-- Detected Barcode Results Actions (Display on Smaller Screen) -->
                                                                <MudHidden Breakpoint="Breakpoint.SmAndUp">
                                                                    <MudMenu Icon="@Icons.Material.Rounded.MoreVert"
                                                                             Size="Size.Small"
                                                                             AnchorOrigin="Origin.TopRight"
                                                                             TransformOrigin="Origin.BottomRight"
                                                                             Disabled="isBusy"
                                                                             Dense>
                                                                        <MudMenuItem Label="Edit"
                                                                                     Icon="@Icons.Material.Rounded.Edit"
                                                                                     OnClick="@(() => OpenCategoryEditDialogAsync(detectedBarcode))" />
                                                                        <MudMenuItem Label="Delete"
                                                                                     Icon="@Icons.Material.Rounded.DeleteOutline"
                                                                                     OnClick="@(() => DeleteDetectedBarcodeConfirmationAsync(img, detectedBarcode))" />
                                                                    </MudMenu>
                                                                </MudHidden>

                                                                <!-- Detected Barcode Results Actions (Display on Larger Screen) -->
                                                                <MudHidden Breakpoint="Breakpoint.Xs">
                                                                    <!-- Edit Scanned Result Button -->
                                                                    <MudTooltip Text="Edit" Placement="Placement.Left" Delay="250" Arrow>
                                                                        <MudIconButton Icon="@Icons.Material.Rounded.Edit"
                                                                                       Color="Color.Primary"
                                                                                       Size="Size.Small"
                                                                                       Disabled="@isSaving"
                                                                                       OnClick="@(() => OpenCategoryEditDialogAsync(detectedBarcode))" />
                                                                    </MudTooltip>

                                                                    <!-- Delete Scanned Result Button -->
                                                                    <MudTooltip Text="Delete" Placement="Placement.Left" Delay="250" Arrow>
                                                                        <MudIconButton Icon="@Icons.Material.Rounded.DeleteOutline"
                                                                                       Color="Color.Error"
                                                                                       Size="Size.Small"
                                                                                       Disabled="@isSaving"
                                                                                       OnClick="@(() => DeleteDetectedBarcodeConfirmationAsync(img, detectedBarcode))" />
                                                                    </MudTooltip>
                                                                </MudHidden>
                                                            </MudStack>
                                                        </td>
                                                    </tr>
                                                }
                                            </tbody>
                                        </MudSimpleTable>
                                    }
                                </MudCollapse>
                            </MudCardContent>
                        </MudCard>
                    }
                </MudStack>
            }
        </MudItem>

        <!-- Toolbar Section for Uploading Images -->
        <MudItem Class="position-sticky" Style="bottom: 24px">
            <MudPaper Class="px-3 py-2 mud-theme-primary" Elevation="0" Style="border-radius: 40px">
                <MudStack Row Spacing="2" AlignItems="AlignItems.Center" Justify="Justify.SpaceEvenly">
                    @if (factor != "Web")
                    {
                        <MudTooltip Text="Scan Barcodes" Placement="Placement.Top" Delay="250" Arrow>
                            <MudFab Color="Color.Primary"
                                    Size="Size.Small"
                                    StartIcon="material-symbols-rounded/barcode_scanner"
                                    OnClick="OpenScanner"
                                    DropShadow="false" />
                        </MudTooltip>
                    }

                    <!-- Image File picker -->
                    <MudFileUpload T="IReadOnlyList<IBrowserFile>"
                                   Accept=".jpg,.jpeg,.png,.heic,.heif,image/*"
                                   FilesChanged="UploadImageFilesAsync"
                                   MaximumFileCount="50"
                                   Disabled="@(isUploadingImg || isSaving)">
                        <ActivatorContent>
                            <MudFab Class="text-white"
                                    Label="Upload Images"
                                    Color="Color.Primary"
                                    Size="Size.Small"
                                    StartIcon="@Icons.Material.Outlined.FileUpload"
                                    DropShadow="false"
                                    Style="color: white !important" />
                        </ActivatorContent>
                    </MudFileUpload>

                    <MudSpacer />

                    <MudTooltip Text="Submit" Placement="Placement.Top" Delay="250" Arrow>
                        <MudFab Color="Color.Primary"
                                Size="Size.Small"
                                StartIcon="material-symbols-rounded/database_upload"
                                OnClick="SaveDetectedBarcodesConfirmationAsync"
                                DropShadow="false"
                                Disabled="isSaving" />
                    </MudTooltip>

                    <MudTooltip Text="Clear All" Placement="Placement.Top" Delay="250" Arrow>
                        <MudFab Color="Color.Warning"
                                Size="Size.Small"
                                StartIcon="@Icons.Material.Rounded.ClearAll"
                                Disabled="isBusy"
                                DropShadow="false"
                                OnClick="ClearAllUploadedImagesConfirmationAsync" />
                    </MudTooltip>
                </MudStack>
            </MudPaper>
        </MudItem>
    @* </MudStack> *@
    
</MudContainer>

@code {
    private const long maxFileBytes = 20L * 1024 * 1024; // 20 MB per file
    private static readonly string[] allowedContentTypes = { "image/jpeg", "image/png", "image/heic", "image/heif" };

    private List<ImgItemViewModel> uploadedImageFiles { get; } = new();
    private HashSet<Guid> expandedResults { get; set; } = new();
    private BarcodeMode barcodeMode { get; set; } = BarcodeMode.Standard;
    private bool isBusy { get; set; }
    private bool isUploadingImg { get; set; }
    private bool isSaving { get; set; }
    private int decodeProgress { get; set; }
    private int uploadImgProgress { get; set; }

    private string factor => FormFactor.GetFormFactor();
    private string platform => FormFactor.GetPlatform();

    private bool IsExpanded(Guid imgId) => expandedResults.Contains(imgId);

    private void CollapseAll() => expandedResults.Clear();

    private async Task OpenScanner() => await Detector.NavigateToScannerAsync();

    private static Color ImageFileStateColor(FileState state) => state switch
    {
        FileState.Ready => Color.Info,
        FileState.Detecting => Color.Warning,
        FileState.Done => Color.Success,
        FileState.Error => Color.Error,
        _ => Color.Default
    };

    private static string ImageFileStateLabel(FileState state) => state switch
    {
        FileState.Ready => "Ready",
        FileState.Detecting => "Detecting...",
        FileState.Done => "Done",
        FileState.Error => "Error",
        _ => "—"
    };

    private void ToggleResults(Guid imgId)
    {
        if (!expandedResults.Add(imgId))
            expandedResults.Remove(imgId);
    }

    // Optional bulk actions (handy if you add toolbar buttons)
    private void ExpandAll()
    {
        expandedResults = uploadedImageFiles.Where(f => f.DetectResult?.Barcodes?.Any() == true)
            .Select(f => f.Id)
            .ToHashSet();
    }

    // MULTI-FILE handler (preferred)
    private async Task UploadImageFilesAsync(IReadOnlyList<IBrowserFile> files)
    {
        if (files == null || files.Count == 0)
            return;

        isUploadingImg = true;
        uploadImgProgress = 0;

        var totalFiles = files.Count;
        double processedFile = 0;

        try
        {
            foreach (var file in files)
            {
                await AddImageFileAsync(file);

                processedFile++;
                uploadImgProgress = Math.Clamp(
                    (int)Math.Round(processedFile / totalFiles * 100.0),
                    0, 100);

                StateHasChanged();
                await Task.Yield();
            }

            // Ensure it lands on 100 after loop (even if rounding)
            uploadImgProgress = 100;
        }
        finally
        {
            isUploadingImg = false;
            StateHasChanged();
        }
    }


    // If you change T="IBrowserFile", use this single-file overload instead:
    // private async Task UploadImageFilesAsync(IBrowserFile file) => await AddImageFileAsync(file);
    private async Task AddImageFileAsync(IBrowserFile file)
    {
        var contentType = string.IsNullOrWhiteSpace(file.ContentType) ? "image/jpeg" : file.ContentType.ToLowerInvariant();
        if (!allowedContentTypes.Contains(contentType) && !contentType.StartsWith("image/"))
            return;

        try
        {
            await using var readFile = file.OpenReadStream(maxFileBytes);
            using var ms = new MemoryStream();
            await readFile.CopyToAsync(ms);

            var bytes = ms.ToArray();
            var preview = $"data:{contentType};base64,{Convert.ToBase64String(bytes)}";

            uploadedImageFiles.Add(new ImgItemViewModel
            {
                Id = Guid.NewGuid(),
                FileName = string.IsNullOrWhiteSpace(file.Name) ? $"{Guid.NewGuid():N}.jpg" : file.Name,
                ContentType = contentType,
                Bytes = bytes,
                PreviewDataUrl = preview,
                State = FileState.Ready
            });
        }
        catch (Exception ex)
        {
            uploadedImageFiles.Add(new ImgItemViewModel
            {
                Id = Guid.NewGuid(),
                FileName = file.Name ?? "image",
                ContentType = contentType,
                State = FileState.Error,
                ErrorMessage = ex.Message
            });
        }
        StateHasChanged();
    }

    /// <summary>
    /// Displays a confirmation dialog asking the user to confirm deleting the
    /// current uploaded image.
    /// </summary>
    private async Task DeleteUploadedImgConfirmationAsync(ImgItemViewModel imgItem)
    {
        if (isUploadingImg || isSaving || isBusy)
            return;

        var parameters = new DialogParameters<ConfirmationDialog>
        {
            { x => x.ContentText, "Are you sure you want to delete this uploaded image? This action is permanent and cannot be undone." },
            { x => x.SubmitBtnText, "Delete" },
            { x => x.DialogIcon, Icons.Material.Rounded.Warning },
            { x => x.DialogIconColor, Color.Error }
        };
        var options = new DialogOptions() { CloseButton = true, CloseOnEscapeKey = true, MaxWidth = MaxWidth.ExtraSmall, FullWidth = true };
        var dialog = await DialogService.ShowAsync<ConfirmationDialog>("Delete Confirmation", parameters, options);
        var result = await dialog.Result;

        if (!result.Canceled)
        {
            uploadedImageFiles.Remove(imgItem);
        }
    }

    /// <summary>
    /// Displays a dialog prompting the user to edit the
    /// current detected barcode's category.
    /// </summary>
    private async Task OpenCategoryEditDialogAsync(ScanBarcodeItemViewModel barcodeItem)
    {
        var parameters = new DialogParameters<CategoryEditDialog>
        {
            { x => x.BarcodeItem, barcodeItem },
        };
        var options = new DialogOptions() { CloseButton = true, CloseOnEscapeKey = true, MaxWidth = MaxWidth.ExtraSmall, FullWidth = true };
        var dialog = await DialogService.ShowAsync<CategoryEditDialog>("Edit Category", parameters, options);
        var result = await dialog.Result;

        if (!result.Canceled)
        {
            StateHasChanged();
            Snackbar.Add("Category updated.", Severity.Success);
        }
    }

    /// <summary>
    /// Displays a confirmation dialog asking the user to confirm deleting the
    /// current detected barcode result.
    /// </summary>
    private async Task DeleteDetectedBarcodeConfirmationAsync(ImgItemViewModel imgItem, ScanBarcodeItemViewModel barcodeItem)
    {
        if (isUploadingImg || isSaving || isBusy)
            return;

        var parameters = new DialogParameters<ConfirmationDialog>
        {
            { x => x.ContentText, "Are you sure you want to delete this detected barcode? This action is permanent and cannot be undone." },
            { x => x.SubmitBtnText, "Delete" },
            { x => x.DialogIcon, Icons.Material.Rounded.Warning },
            { x => x.DialogIconColor, Color.Error }
        };
        var options = new DialogOptions() { CloseButton = true, CloseOnEscapeKey = true, MaxWidth = MaxWidth.ExtraSmall, FullWidth = true };
        var dialog = await DialogService.ShowAsync<ConfirmationDialog>("Delete Confirmation", parameters, options);
        var result = await dialog.Result;

        if (!result.Canceled)
        {
            if (imgItem.DetectResult.Barcodes.Contains(barcodeItem))
                imgItem.DetectResult.Barcodes.Remove(barcodeItem);
        }
    }

    /// <summary>
    /// Displays a confirmation dialog asking the user to confirm clearing all
    /// uploaded images currently shown in the list.
    /// </summary>
    private async Task ClearAllUploadedImagesConfirmationAsync()
    {
        var parameters = new DialogParameters<ConfirmationDialog>
        {
            { x => x.ContentText, "Are you sure you want to clear all the uploaded images? This action is permanent and cannot be undone." },
            { x => x.SubmitBtnText, "Clear" },
            { x => x.DialogIcon, Icons.Material.Rounded.Warning },
            { x => x.DialogIconColor, Color.Error }
        };
        var options = new DialogOptions() { CloseButton = true, CloseOnEscapeKey = true, MaxWidth = MaxWidth.ExtraSmall, FullWidth = true };
        var dialog = await DialogService.ShowAsync<ConfirmationDialog>("Clear All Confirmation", parameters, options);
        var result = await dialog.Result;

        if (!result.Canceled)
        {
            uploadedImageFiles.Clear();
            isBusy = false;
            decodeProgress = 0;
        }
    }

    private async Task DecodeBarcodes()
    {
        isBusy = true;
        decodeProgress = 5;

        try
        {
            int idx = 0;
            foreach (var item in uploadedImageFiles)
            {
                if (item.Bytes is null)
                {
                    item.State = FileState.Error;
                    continue;
                }

                item.State = FileState.Detecting;
                StateHasChanged();

                await Task.Delay(100); // Optional delay for UI feedback

                // Use your decoder service
                var results = Detector.DecodeFromImage(item.Bytes);

                item.DetectResult = new DetectResultViewModel
                {
                    Barcodes = results
                };

                item.State = FileState.Done;

                if (!IsExpanded(item.Id) && item.DetectResult.Barcodes.Count > 0)
                    ToggleResults(item.Id);

                idx++;
                decodeProgress = Math.Clamp(5 + (int)((double)idx / uploadedImageFiles.Count * 95), 5, 100);
            }

            decodeProgress = 100;
        }
        catch (Exception ex)
        {
            foreach (var item in uploadedImageFiles)
            {
                item.State = FileState.Error;
                item.ErrorMessage ??= ex.Message;
            }
        }
        finally
        {
            isBusy = false;
            StateHasChanged();
        }
    }

    private static string FormatBytes(long bytes)
    {
        if (bytes <= 0) return "0 B";
        string[] units = ["B", "KB", "MB", "GB"];
        var pow = (int)Math.Floor(Math.Log(bytes, 1024));
        pow = Math.Clamp(pow, 0, units.Length - 1);
        var val = bytes / Math.Pow(1024, pow);
        return $"{val:0.##} {units[pow]}";
    }

    // Open dialog for previewing images.
    private async Task OpenPreviewImgDialogAsync(Guid imgFileId)
    {
        if (uploadedImageFiles == null || uploadedImageFiles.Count == 0)
        {
            Snackbar.Add("No images to preview.", Severity.Warning);
            return;
        }

        // Resolve starting index; default to 0 if the id is not found
        var index = uploadedImageFiles.FindIndex(x => x.Id == imgFileId);
        if (index < 0) index = 0;

        var parameters = new DialogParameters<PreviewImgDialog>
        {
            { x => x.ImageFiles, uploadedImageFiles },   // pass the SAME list instance
            { x => x.SelectedFileIndex, index },         // start at resolved index
        };
        var options = new DialogOptions() { NoHeader = true, CloseOnEscapeKey = true, MaxWidth = MaxWidth.Large, FullWidth = true };

        try
        {
            var dialog = await DialogService.ShowAsync<PreviewImgDialog>("Preview Image", parameters, options);
            var result = await dialog.Result;
            return;
        }
        catch (Exception ex)
        {
            Snackbar.Add($"Failed to open image preview: {ex.Message}", Severity.Error);
        }
    }

    /// <summary>
    /// Displays a confirmation dialog asking the user to confirm uploading all the
    /// detected barcodes.
    /// </summary>
    private async Task SaveDetectedBarcodesConfirmationAsync()
    {
        var totalBarcodes = uploadedImageFiles
            .Where(f => f.DetectResult?.Barcodes?.Any() ?? false)
            .Sum(f => f.DetectResult.Barcodes.Count);

        var message = totalBarcodes == 1
            ? "Are you sure you want to upload this detected barcode?"
            : $"Are you sure you want to upload these {totalBarcodes} detected barcodes?";

        var parameters = new DialogParameters<ConfirmationDialog>
        {
            { x => x.ContentText, message },
            { x => x.SubmitBtnText, "Upload" },
            { x => x.DialogIconColor, Color.Info }
        };
        var options = new DialogOptions() { CloseButton = true, CloseOnEscapeKey = true, MaxWidth = MaxWidth.ExtraSmall, FullWidth = true };
        var dialog = await DialogService.ShowAsync<ConfirmationDialog>("Upload Confirmation", parameters, options);
        var result = await dialog.Result;

        if (!result.Canceled)
        {
            try
            {
                await SaveDetectedBarcodesAsync();
            }
            catch
            {
                Snackbar.Add("An unexpected error occurred while uploading the detected barcodes. Please try again.", Severity.Error);
            }
        }
    }

    /// <summary>
    /// Uploads the current detected barcode results to the database via IScannedBarcodeService.
    /// Deduplication is handled by the service layer.
    /// </summary>
    private async Task SaveDetectedBarcodesAsync()
    {
        if (isSaving)
            return;

        var barcodeItems = uploadedImageFiles
            .Where(f => f.DetectResult?.Barcodes?.Any() ?? false)
            .SelectMany(f => f.DetectResult.Barcodes)
            .ToList();

        if (barcodeItems.Count == 0)
        {
            Snackbar.Add("No detected barcodes to upload.", Severity.Info);
            return;
        }

        isSaving = true;
        try
        {
            // Short timeout to keep UX snappy on mobile
            using var cts = new CancellationTokenSource(TimeSpan.FromSeconds(30));

            var response = await ScannedBarcodeService.AddScannedBarcodesAsync(barcodeItems, cts.Token);
            if (response.Success)
            {
                Snackbar.Add(response.Message ?? $"{response.Data} barcode(s) uploaded.", Severity.Success);
                uploadedImageFiles.Clear();
            }
            else
            {
                Snackbar.Add(response.Message ?? "Upload failed.", Severity.Error);
            }
        }
        catch (OperationCanceledException)
        {
            Snackbar.Add("Upload cancelled or timed out.", Severity.Warning);
        }
        catch (Exception ex)
        {
            Snackbar.Add($"Upload error: {ex.Message}", Severity.Error);
        }
        finally
        {
            isSaving = false;
            StateHasChanged();
        }
    }
}