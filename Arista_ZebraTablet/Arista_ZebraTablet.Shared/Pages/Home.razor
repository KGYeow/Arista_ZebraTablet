@page "/"

@using Arista_ZebraTablet.Shared.Application.Enums
@using Arista_ZebraTablet.Shared.Application.ViewModels

<PageTitle>Home | @AppConstant.AppTitle</PageTitle>

<MudBreakpointProvider OnBreakpointChanged="HandleBreakpointChanged">
    <MudContainer Class="pt-5 pb-0 px-4 position-sticky" MaxWidth="MaxWidth.Large">
        <!-- Barcode Source Toggle Button -->
        <MudGrid Spacing="4" Justify="Justify.Center">
            <MudItem Class="d-flex gap-3" xs="12" sm="6">
                <MudToggleGroup T="BarcodeSource"
                                Value="@barcodeSource"
                                ValueChanged="ChangeBarcodeResultTabPanel"
                                SelectionMode="SelectionMode.SingleSelection"
                                SelectedClass="bg-white"
                                Color="Color.Inherit"
                                Size="Size.Small"
                                Class="mud-theme-primary flex-grow-1"
                                Outlined="false">
                    <MudToggleItem Text="Image Upload" Value="BarcodeSource.Upload" Class="ma-1 rounded"/>
                    <MudToggleItem Text="Scanner" Value="BarcodeSource.Camera" Class="ma-1 rounded" />
                </MudToggleGroup>

                <!-- Setting Button & Setting Options Drawer  -->
                <BarcodeSettingsDrawer BarcodeMode="barcodeMode"/>
            </MudItem>
        </MudGrid>
    </MudContainer>

    <MudTabs
        @ref="barcodeSoureTabs"
        Elevation="0"
        Class="my-3 position-relative"
        PanelClass="px-4 h-100 d-flex flex-column gap-3 overflow-auto"
        TabHeaderClass="mx-4 p-1 d-none"
        Style="flex: 1 1 auto; min-height: 0;"
    >
        @{
            var hasBarcodeGroups = barcodeGroups.Any(g => g.Source == barcodeSource);
        }

        <!-- Image Upload List & Result Tab Panel -->
        <MudTabPanel Text="Image Upload" ID="@(BarcodeSource.Upload.ToString())" Style="flex: 1 1 auto; min-height: 0;">
            <!-- Uploading Images Progress / Uploading Detected Barcodes Progress / Processing Progress -->
            <LoadingOverlay
                Visible="@(isUploadingImg || isUploadingResults || isBusy)"
                Text="@(isUploadingImg ? $"Uploading images... {uploadImgProgress}%" : (isUploadingResults ? "Uploading detected barcodes" : "Detecting barcodes..."))"
            />

            @if (!hasBarcodeGroups && !isUploadingImg)
            {
                <MudStack Class="h-100" Spacing="4" Justify="Justify.FlexEnd" AlignItems="AlignItems.Center">
                    <MudItem xs="12" sm="6" Class="@($"{(currentBreakpoint == Breakpoint.Xs ? "align-content-center" : "align-content-end")}")">
                        <MudPaper Class="pa-4 bg-transparent" Elevation="0">
                            <MudStack Spacing="3" AlignItems="AlignItems.Center" Justify="Justify.SpaceBetween">
                                <!-- Instruction Section -->
                                <MudStack Spacing="2" AlignItems="AlignItems.Center">
                                    <MudText Typo="Typo.h5" Class="fw-bold">Image Upload Detection</MudText>
                                    <MudText Typo="Typo.body2" Class="text-center">
                                        Upload one or more images and tap <MudIcon Size="Size.Small" Icon="material-symbols-rounded/scan" /><b> Detect Barcodes</b> to begin.<br />
                                    </MudText>
                                </MudStack>
                            </MudStack>
                        </MudPaper>
                    </MudItem>
                </MudStack>
            }
            else
            {
                <!-- Uploaded Image File Preview Cards -->    
                <BarcodeGroupList
                    BarcodeGroups="barcodeGroups"
                    Source="BarcodeSource.Upload"
                    IsBusy="isBusy"
                    IsUploadingImg="isUploadingImg"
                    IsUploadingResults="isUploadingResults" />
            }
        </MudTabPanel>

        <!-- Scanned Barcodes List & Result Tab Panel -->
        <MudTabPanel Text="Scanner" ID="@(BarcodeSource.Camera.ToString())" Style="flex: 1 1 auto; min-height: 0;">
            @if (!hasBarcodeGroups)
            {
                <MudStack Class="h-100" Spacing="4" Justify="Justify.FlexEnd" AlignItems="AlignItems.Center">
                    <MudItem xs="12" sm="6" Class="@($"{(currentBreakpoint == Breakpoint.Xs ? "align-content-center" : "align-content-end")}")">
                        <MudPaper Class="pa-4 bg-transparent" Elevation="0">
                            <MudStack Spacing="3" AlignItems="AlignItems.Center" Justify="Justify.SpaceBetween">
                                <!-- Instruction Section -->
                                <MudStack Spacing="2" AlignItems="AlignItems.Center">
                                    <MudText Typo="Typo.h5" Class="fw-bold">Scanner Barcode Detection</MudText>
                                    <MudText Typo="Typo.body2" Class="text-center">
                                        Tap <MudIcon Size="Size.Small" Icon="material-symbols-rounded/barcode_scanner" /><b> Barcode Scanner</b> to begin.<br />
                                    </MudText>
                                </MudStack>
                            </MudStack>
                        </MudPaper>
                    </MudItem>
                </MudStack>
            }
            else
            {
                <!-- Scanned Barcode Preview Cards -->    
                <BarcodeGroupList
                    BarcodeGroups="barcodeGroups"
                    Source="BarcodeSource.Camera"
                    IsBusy="isBusy"
                    IsUploadingImg="isUploadingImg"
                    IsUploadingResults="isUploadingResults" />
            }
        </MudTabPanel>
    </MudTabs>

    <!-- Toolbar Section -->
    <MudContainer
        Class="@($"pt-0 pb-5 px-4 {(currentBreakpoint == Breakpoint.Xs || isUploadingImg || barcodeGroups.Any() ? "" : "flex-grow-1")}")"
        MaxWidth="MaxWidth.Large"
        Style="height:fit-content;"
    >
        <MudGrid Spacing="0" Justify="Justify.Center">
            <MudItem xs="12" sm="9" Class="position-sticky">
                <MudPaper Class="px-3 py-2 mud-theme-primary rounded-pill" Elevation="0">
                    <MudStack Row Spacing="2" AlignItems="AlignItems.Center" Justify="Justify.SpaceEvenly">
                        <!-- More Button & More Options Menu (Display on Larger Screen) -->
                        <MudHidden Breakpoint="Breakpoint.Xs">
                            <MudMenu
                                AnchorOrigin="Origin.TopLeft"
                                TransformOrigin="Origin.BottomLeft"
                                Disabled="isBusy"
                                Dense
                            >
                                <ActivatorContent>
                                    <MudFab
                                        Color="Color.Secondary"
                                        Size="Size.Small"
                                        StartIcon="material-symbols-rounded/add"
                                        DropShadow="false"
                                    />
                                </ActivatorContent>
                                <ChildContent>
                                    <MudMenuItem
                                        Label="Barcode Scanner"
                                        Icon="material-symbols-rounded/barcode_scanner"
                                        OnClick="OpenBarcodeScanner"/>
                                    <MudDivider/>
                                    <MudMenuItem
                                        Label="Copy All"
                                        Icon="material-symbols-rounded/content_copy"
                                        OnClick="CopyAllResults" />
                                    <MudMenuItem
                                        Label="Reorder All"
                                        Icon="material-symbols-rounded/reorder"
                                        OnClick="() => EnableReorderMode()" />
                                </ChildContent>
                            </MudMenu>
                        </MudHidden>

                        <!-- More Button & More Options Drawer (Display on Smaller Screen) -->
                        <MudHidden Breakpoint="Breakpoint.SmAndUp">
                            <!-- More Button -->
                            <MudItem>
                                <MudFab Color="Color.Secondary"
                                        OnClick="ToggleMoreDrawer"
                                        Size="Size.Small"
                                        StartIcon="material-symbols-rounded/add"
                                        DropShadow="false" />
                            </MudItem>

                            <!-- More Options Drawer -->
                            <MudDrawer @bind-Open="@moreDrawerOpen" Anchor="@Anchor.Bottom" Elevation="25" Variant="@DrawerVariant.Temporary" Style="border-top-left-radius: 16px; border-top-right-radius: 16px;">
                                <MudSwipeArea @ref="@swipeArea" Class="w-100" OnSwipeMove="@HandleSwipeMove" OnSwipeEnd="@ResetSwipeArea" OnSwipeLeave="@OnSwipeLeave" PreventDefault>
                                    <MudNavMenu class="py-3" Color="Color.Info">
                                        <MudContainer Class="px-3 d-flex flex-column" Gutters="false">
                                            <MudStack Row Spacing="2" Justify="Justify.Center">
                                                <MudButton Class="pa-4 flex-grow-1"
                                                            Variant="Variant.Filled"
                                                            Color="Color.Secondary"
                                                            DropShadow="false"
                                                            OnClick="OpenBarcodeScanner">
                                                    <div class="d-flex flex-column align-items-center">
                                                        <MudIcon Icon="material-symbols-rounded/barcode_scanner" />
                                                        Barcode Scanner
                                                    </div>
                                                </MudButton>
                                            </MudStack>
                                            <MudDivider Class="my-3" />
                                        </MudContainer>
                                        <MudNavLink Icon="material-symbols-rounded/content_copy"
                                                    ActiveClass=""
                                                    OnClick="CopyAllResults"
                                                    Disabled="isUploadingResults">
                                            Copy All
                                        </MudNavLink>
                                        <MudNavLink Icon="material-symbols-rounded/reorder"
                                                    ActiveClass=""
                                                    OnClick="() => EnableReorderMode()"
                                                    Disabled="isUploadingResults">
                                            Reorder All
                                        </MudNavLink>
                                    </MudNavMenu>
                                </MudSwipeArea>
                            </MudDrawer>
                        </MudHidden>

                        <!-- Image File picker -->
                        <MudFileUpload T="IReadOnlyList<IBrowserFile>"
                                       Class="w-100"
                                       Accept=".jpg,.jpeg,.png,image/*"
                                       FilesChanged="UploadImageFilesAsync"
                                       MaximumFileCount="50"
                                       Disabled="@(isUploadingImg || isUploadingResults)">
                            <ActivatorContent>
                                <MudFab Class="text-white w-100"
                                        Label="Upload Images"
                                        Color="Color.Secondary"
                                        Size="Size.Small"
                                        StartIcon="@Icons.Material.Outlined.FileUpload"
                                        DropShadow="false"
                                        Style="color: white !important" />
                            </ActivatorContent>
                        </MudFileUpload>

                        <!-- Detect Barcodes Button -->
                        <MudTooltip Text="Detect Barcodes" Placement="Placement.Top" Delay="400" Arrow>
                            <MudFab Color="Color.Secondary"
                                    Size="Size.Small"
                                    StartIcon="material-symbols-rounded/scan"
                                    OnClick="DecodeBarcodes"
                                    DropShadow="false" />
                        </MudTooltip>

                        <!-- Clear All Button -->
                        <MudTooltip Text="Clear All" Placement="Placement.Top" Delay="400" Arrow>
                            <MudFab Color="Color.Warning"
                                    Size="Size.Small"
                                    StartIcon="@Icons.Material.Rounded.ClearAll"
                                    Disabled="isBusy"
                                    DropShadow="false"
                                    OnClick="ClearAllUploadedImagesConfirmationAsync" />
                        </MudTooltip>
                    </MudStack>
                </MudPaper>
            </MudItem>
        </MudGrid>
    </MudContainer>
</MudBreakpointProvider>