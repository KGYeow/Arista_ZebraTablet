@using System.Collections.ObjectModel
@using Arista_ZebraTablet.Services
@using Arista_ZebraTablet.Shared.Application.ViewModels
@using Arista_ZebraTablet.Shared.Services

@inject BarcodeScannerService scanResultsService
@inject IScannedBarcodeService ScannedBarcodeService
@implements IDisposable

<MobileComponentLayout>
    <Body>
        <MudStack Row AlignItems="AlignItems.Center" Spacing="2" Class="mb-4">
            <!-- Title + Live Scanned Result Count -->
            <MudStack Row AlignItems="AlignItems.Center" Spacing="1">
                <MudText Typo="Typo.h6">Scanned Results</MudText>

                @if (scanResultsService.Results.Count > 0)
                {
                    <MudChip T="string" Size="Size.Small" Color="Color.Primary" Variant="Variant.Filled">
                        @scanResultsService.Results.Count
                    </MudChip>
                }
            </MudStack>

            <MudSpacer/>

            <MudStack Row AlignItems="AlignItems.Center" Spacing="2">
                <!-- Submit Button -->
                <MudTooltip Text="Submit" Placement="Placement.Left" Delay="250" Arrow>
                    <MudIconButton
                        Color="Color.Primary"
                        Icon="material-symbols-rounded/database_upload"
                        Variant="Variant.Filled"
                        Size="Size.Small"
                        Disabled="@(!scanResultsService.Results.Any() || isSaving)"
                        DropShadow="false"
                        OnClick="SaveScannedResultConfirmationAsync"
                    />
                </MudTooltip>

                <!-- Clear Button -->
                <MudTooltip Text="Clear All" Placement="Placement.Left" Delay="250" Arrow>
                    <MudIconButton
                        Color="Color.Warning"
                        Icon="@Icons.Material.Rounded.ClearAll"
                        Variant="Variant.Outlined"
                        Size="Size.Small"
                        DropShadow="false"
                        Disabled="@(!scanResultsService.Results.Any() || isSaving)"
                        OnClick="ClearScannedResultConfirmationAsync"
                    />
                </MudTooltip>
            </MudStack>
        </MudStack>
        <MudItem>
            <!-- Scanned Barcode's Result Cards -->
            <MudStack Spacing="2">
                @if (!scanResultsService.Results.Any())
                {
                    <MudAlert Severity="Severity.Info" ContentAlignment="HorizontalAlignment.Center">
                        No scans yet. Aim the camera at a code.
                    </MudAlert>
                }
                else
                {
                    @foreach (var barcodeItem in scanResultsService.Results)
                    {
                        <MudPaper Class="pa-3" Elevation="0" Outlined>
                            <MudStack Row Spacing="2">
                                <MudStack>
                                    <MudText Typo="Typo.caption" Class="pb-2">@barcodeItem.ScannedTime.ToLocalTime().ToString("hh:mm:ss tt")</MudText>
                                    <MudText Typo="Typo.subtitle2" GutterBottom="false">@barcodeItem.Category</MudText>
                                    <MudText Typo="Typo.body1" Class="fw-bold" GutterBottom="false">@barcodeItem.Value</MudText>
                                </MudStack>

                                <MudSpacer />

                                <MudStack Row Spacing="2" AlignItems="AlignItems.Center">
                                    <!-- Edit Scanned Result Button -->
                                    <MudTooltip Text="Edit" Placement="Placement.Left" Delay="250" Arrow>
                                        <MudIconButton
                                            Icon="@Icons.Material.Filled.Edit"
                                            Color="Color.Primary"
                                            Size="Size.Small"
                                            Disabled="@isSaving"
                                        />
                                    </MudTooltip>

                                    <!-- Delete Scanned Result Button -->
                                    <MudTooltip Text="Delete" Placement="Placement.Left" Delay="250" Arrow>
                                        <MudIconButton
                                            Icon="@Icons.Material.Filled.Delete"
                                            Color="Color.Error"
                                            Size="Size.Small"
                                            Disabled="@isSaving"
                                            OnClick="@(() => DeleteBarcode(barcodeItem))"
                                        />
                                    </MudTooltip>
                                </MudStack>
                            </MudStack>
                        </MudPaper>
                    }
                }
            </MudStack>
        </MudItem>
    </Body>
</MobileComponentLayout>

@code {
    // private ObservableCollection<ScanBarcodeItemViewModel> scanResultsService = new();
    // private IReadOnlyList<ScanBarcodeItemViewModel> scanBarcodeItems = Array.Empty<ScanBarcodeItemViewModel>();
    private System.Collections.Specialized.NotifyCollectionChangedEventHandler? _sub;

    private bool isSaving;

    protected override void OnInitialized()
    {
        // scanBarcodeItems = scanResultsService.Results;
        _sub = (_, __) => InvokeAsync(StateHasChanged);
        scanResultsService.Results.CollectionChanged += _sub;
    }
    public void Dispose()
    {
        if (_sub is not null)
            scanResultsService.Results.CollectionChanged -= _sub;
    }

    /// <summary>
    /// Displays a confirmation dialog asking the user to confirm submitting the
    /// current scanned barcode results.
    /// </summary>
    private async Task SaveScannedResultConfirmationAsync()
    {
        var message = scanResultsService.Results.Count == 1
            ? "Are you sure you want to submit this scanned barcode result?"
            : $"Are you sure you want to submit these {scanResultsService.Results.Count} scanned barcode results?";

        var parameters = new DialogParameters<ConfirmationDialog>
        {
            { x => x.ContentText, message },
            { x => x.SubmitBtnText, "Submit" },
            { x => x.DialogIconColor, Color.Info }
        };
        var options = new DialogOptions() { CloseButton = true, CloseOnEscapeKey = true, MaxWidth = MaxWidth.ExtraSmall };
        var dialog = await DialogService.ShowAsync<ConfirmationDialog>("Submit Confirmation", parameters, options);
        var result = await dialog.Result;

        if (!result.Canceled)
        {
            try
            {
                await SaveScannedResultAsync();
            }
            catch
            {
                Snackbar.Add("An unexpected error occurred while submitting the scanned barcode. Please try again.", Severity.Error);
            }
        }
    }

    /// <summary>
    /// Submits the current scanned results to the database via IScannedBarcodeService.
    /// Deduplication is handled by the service layer.
    /// </summary>
    private async Task SaveScannedResultAsync()
    {
        if (isSaving || !scanResultsService.Results.Any())
            return;

        isSaving = true;
        try
        {
            // Map to a new list to avoid collection mutation during async call
            var items = scanResultsService.Results.ToList();
            if (items.Count == 0)
            {
                Snackbar.Add("Nothing to submit.", Severity.Info);
                return;
            }

            // Short timeout to keep UX snappy on mobile
            using var cts = new CancellationTokenSource(TimeSpan.FromSeconds(30));

            var response = await ScannedBarcodeService.AddScannedBarcodesAsync(items, cts.Token);
            if (response.Success)
            {
                Snackbar.Add(response.Message ?? $"{response.Data} barcode(s) submitted.", Severity.Success);
                scanResultsService.Clear();
            }
            else
            {
                Snackbar.Add(response.Message ?? "Submit failed.", Severity.Error);
            }
        }
        catch (OperationCanceledException)
        {
            Snackbar.Add("Submit cancelled or timed out.", Severity.Warning);
        }
        catch (Exception ex)
        {
            Snackbar.Add($"Submit error: {ex.Message}", Severity.Error);
        }
        finally
        {
            isSaving = false;
            StateHasChanged();
        }
    }
    /// <summary>
    /// Displays a confirmation dialog asking the user to confirm clearing all
    /// scanned barcode results currently shown in the list.
    /// </summary>
    private async Task ClearScannedResultConfirmationAsync()
    {
        if (isSaving || !scanResultsService.Results.Any())
            return;

        var parameters = new DialogParameters<ConfirmationDialog>
        {
            { x => x.ContentText, "Clear all scanned results?" },
            { x => x.SubmitBtnText, "Clear" },
            { x => x.DialogIcon, Icons.Material.Rounded.Warning },
            { x => x.DialogIconColor, Color.Error }
        };
        var options = new DialogOptions() { CloseButton = true, CloseOnEscapeKey = true, MaxWidth = MaxWidth.ExtraSmall };
        var dialog = await DialogService.ShowAsync<ConfirmationDialog>("Confirm Clear", parameters, options);
        var result = await dialog.Result;

        if (!result.Canceled)
            scanResultsService.Clear();
    }

    private void DeleteBarcode(ScanBarcodeItemViewModel barcode)
{
    if (scanResultsService.Results.Contains(barcode))
    {
        scanResultsService.Results.Remove(barcode);
    }
}
}