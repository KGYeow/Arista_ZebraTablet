@using System.Collections.ObjectModel
@using Arista_ZebraTablet.Services
@using Arista_ZebraTablet.Shared.Application.ViewModels
@using Arista_ZebraTablet.Shared.Services
@using Arista_ZebraTablet.Shared.Application.Enums

<MobileComponentLayout>
    <Body>
        <MudContainer Class="py-4" MaxWidth="MaxWidth.Large">
            <MudStack Row AlignItems="AlignItems.Center" Spacing="2" Class="mb-4">
                <!-- Title + Live Scanned Result Count -->
                <MudStack Row AlignItems="AlignItems.Center" Spacing="1">
                    <MudText Typo="Typo.h6">Scanned Results</MudText>

                    @if (scanResultsService.Results.Count > 0)
                    {
                        <MudChip T="string" Size="Size.Small" Color="Color.Primary" Variant="Variant.Filled">
                            @scanResultsService.Results.Count
                        </MudChip>
                    }
                </MudStack>

                <MudSpacer/>

                <!-- Action Buttons -->
                <MudStack Row AlignItems="AlignItems.Center" Spacing="2">
                    <!-- Action Buttons (Display on Larger Screen) -->
                    <MudHidden Breakpoint="Breakpoint.Xs">
                        <!-- Copy to Clipboard Button -->
                        <MudTooltip Text="Copy Results" Placement="Placement.Bottom" Delay="400" Arrow>
                            <MudIconButton Color="Color.Primary"
                                            Icon="@Icons.Material.Rounded.ContentCopy"
                                            Size="Size.Small"
                                            Disabled="@(!scanResultsService.Results.Any() || isSaving)"
                                        OnClick="CopyAllGroupedResultsAsync" />
                        </MudTooltip>

                        <!-- Clear All Button -->
                        <MudTooltip Text="Clear All" Placement="Placement.Left" Delay="400" Arrow>
                            <MudIconButton Color="Color.Warning"
                                            Icon="@Icons.Material.Rounded.ClearAll"
                                            Variant="Variant.Outlined"
                                            Size="Size.Small"
                                            Disabled="isSaving"
                                            OnClick="ClearAllScannedResultConfirmationAsync" />
                        </MudTooltip>
                    </MudHidden>

                    <!-- Action Buttons (Display on Smaller Screen) -->
                    <MudHidden Breakpoint="Breakpoint.SmAndUp">
                        <MudMenu
                            Icon="@Icons.Material.Rounded.MoreVert"
                            Size="Size.Small"
                            AnchorOrigin="Origin.BottomLeft"
                            TransformOrigin="Origin.CenterRight"
                            Disabled="isSaving"
                            Dense
                        >
                            <MudMenuItem
                                Label="Copy Results"
                                Icon="@Icons.Material.Rounded.ContentCopy"
                                        OnClick="CopyAllGroupedResultsAsync" />

                            <MudMenuItem
                                Label="Clear All"
                                Icon="@Icons.Material.Rounded.ClearAll"
                                OnClick="ClearAllScannedResultConfirmationAsync"
                            />


                        </MudMenu>
                    </MudHidden>
                </MudStack>
            </MudStack>              

            <MudItem>
                <!-- Scanned Barcode's Result Cards -->
                <MudStack Class="position-relative" Spacing="2">
                    @if (!scanResultsService.CurrentGroup.Barcodes.Any())
                    {
                        <MudAlert Severity="Severity.Info" ContentAlignment="HorizontalAlignment.Center">
                            No scans yet. Aim the camera at a code.
                        </MudAlert>
                    }
                    else
                    {
                        <MudStack Row Spacing="2" Class="mt-2">
                            <MudButton Color="Color.Primary" Variant="Variant.Filled" FullWidth="true" OnClick="CompleteCurrentScanningGroup">Next</MudButton>
                        </MudStack>

                        <MudCard Class="mb-3" Elevation="1">
                            <MudCardContent>
                                <MudStack Row Justify="Justify.SpaceBetween" AlignItems="AlignItems.Center" Class="mb-2">
                                    <MudText Typo="Typo.subtitle2">Current Frame</MudText>
                                    <MudTooltip Text="Delete Current Frame" Placement="Placement.Left" Delay="400" Arrow>
                                        <MudIconButton
                                            Icon="@Icons.Material.Filled.Delete"
                                            Color="Color.Error"
                                            Size="Size.Small"
                                            Disabled="@isSaving"
                                            OnClick="@(() => DeleteCurrentScanningBarcodeGroupConfirmationAsync())" />
                                    </MudTooltip>
                                </MudStack>

                                <MudDivider Class="my-2" />

                                <MudSimpleTable Dense Bordered Hover Outlined>
                                    <tbody>

                                        @foreach (var detectedBarcode in scanResultsService.CurrentGroup.Barcodes)
                                        {
                                            <tr>
                                                <td>@detectedBarcode.Category</td>
                                                <td>@detectedBarcode.Value</td>
                                                <td style="width: 0;">
                                                    <MudStack Row Spacing="1" AlignItems="AlignItems.Center">
                                                        <MudTooltip Text="Copy" Placement="Placement.Top" Delay="400" Arrow>
                                                            <MudIconButton Icon="@Icons.Material.Filled.ContentCopy"
                                                                            Color="Color.Primary"
                                                                            Size="Size.Small"
                                                                           OnClick="@(() => CopySingleBarcodeAsync(detectedBarcode.Value))" />
                                                        </MudTooltip>

                                                        <MudTooltip Text="Edit" Placement="Placement.Left" Delay="400" Arrow>
                                                            <MudIconButton Icon="@Icons.Material.Filled.Edit"
                                                                            Color="Color.Primary"
                                                                            Size="Size.Small"
                                                                            Disabled="@isSaving"
                                                                           OnClick="@(() => OpenCategoryEditDialogAsync(detectedBarcode))" />
                                                        </MudTooltip>

                                                        <MudTooltip Text="Delete" Placement="Placement.Left" Delay="400" Arrow>
                                                            <MudIconButton Icon="@Icons.Material.Filled.Delete"
                                                                            Color="Color.Error"
                                                                            Size="Size.Small"
                                                                            Disabled="@isSaving"
                                                                            OnClick="@(() => DeleteScannedResultConfirmationAsync(detectedBarcode))" />
                                                        </MudTooltip>
                                                    </MudStack>

                                                </td>
                                            </tr>

                                        }
                                    </tbody>
                                </MudSimpleTable>
                            </MudCardContent>
                        </MudCard>
                    }

                    @if (!scanResultsService.BarcodeGroups.Any())
                    {
                        @* <MudText>No completed machines yet.</MudText> *@
                    }
                    else
                    {

                        <MudText Typo="Typo.h6" Class="mt-4">Final result</MudText>
                        <MudButton Color="Color.Primary" FullWidth="true" Variant="Variant.Filled" OnClick="CompleteAndNavigateHomeAsync">
                            Complete
                        </MudButton>

                        <!-- Scanned Barcode Preview Cards -->
                        <BarcodeGroupList BarcodeGroups="scanResultsService.BarcodeGroups"
                                          Source="BarcodeSource.Camera" />
                    }

                </MudStack>
            </MudItem>
        </MudContainer>
    </Body>
</MobileComponentLayout>

