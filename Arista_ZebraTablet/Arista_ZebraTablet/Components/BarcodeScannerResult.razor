@using System.Collections.ObjectModel
@using Arista_ZebraTablet.Services
@using Arista_ZebraTablet.Shared.Application.ViewModels
@using Arista_ZebraTablet.Shared.Services

@inject BarcodeDetectorService scanResultsService
@inject IScannedBarcodeService ScannedBarcodeService
@implements IDisposable

<MobileComponentLayout>
    <Body>
        <MudStack Row AlignItems="AlignItems.Center" Spacing="2" Class="mb-4">
            <!-- Title + Live Scanned Result Count -->
            <MudStack Row AlignItems="AlignItems.Center" Spacing="1">
                <MudText Typo="Typo.h6">Scanned Results</MudText>

                @if (scanResultsService.Results.Count > 0)
                {
                    <MudChip T="string" Size="Size.Small" Color="Color.Primary" Variant="Variant.Filled">
                        @scanResultsService.Results.Count
                    </MudChip>
                }
            </MudStack>

            <MudSpacer/>

            <MudStack Row AlignItems="AlignItems.Center" Spacing="2">
                <!-- Copy Button -->
                <MudTooltip Text="Copy All Results" Placement="Placement.Top" Delay="250" Arrow>
                <MudIconButton
                        Color="Color.Primary"
                        Size="Size.Small"
                        Icon="@Icons.Material.Filled.ContentCopy"
                        OnClick="CopyAllScannedResultsAsync"
                        Disabled="@(!scanResultsService.Results.Any())" 
                />
                </MudTooltip>
                <!-- Submit Button -->
                <MudTooltip Text="Upload to Database" Placement="Placement.Left" Delay="250" Arrow>
                    <MudIconButton
                        Color="Color.Primary"
                        Icon="material-symbols-rounded/database_upload"
                        Variant="Variant.Filled"
                        Size="Size.Small"
                        Disabled="@(!scanResultsService.Results.Any() || isSaving)"
                        DropShadow="false"
                        OnClick="SaveScannedResultConfirmationAsync"
                    />
                </MudTooltip>

                <!-- Clear Button -->
                <MudTooltip Text="Clear All" Placement="Placement.Left" Delay="250" Arrow>
                    <MudIconButton
                        Color="Color.Warning"
                        Icon="@Icons.Material.Rounded.ClearAll"
                        Variant="Variant.Outlined"
                        Size="Size.Small"
                        DropShadow="false"
                        Disabled="@(!scanResultsService.Results.Any() || isSaving)"
                        OnClick="ClearAllScannedResultConfirmationAsync"
                    />
                </MudTooltip>
            </MudStack>
        </MudStack>

        <MudItem>
            <!-- Scanned Barcode's Result Cards -->
            <MudStack Class="position-relative" Spacing="2">
                @if (!scanResultsService.Results.Any())
                {
                    <MudAlert Severity="Severity.Info" ContentAlignment="HorizontalAlignment.Center">
                        No scans yet. Aim the camera at a code.
                    </MudAlert>
                }
                else
                {
                    @foreach (var barcodeItem in SortedResults)
                    {
                        <MudPaper Class="pa-3" Elevation="0" Outlined>
                            <MudStack Row Spacing="3">
                                <MudStack Spacing="0">
                                    <MudText Typo="Typo.caption" GutterBottom="false">@barcodeItem.Category</MudText>
                                    <MudText Typo="Typo.body1" Class="fw-bold" GutterBottom="false">@barcodeItem.Value</MudText>
                                </MudStack>

                                <MudSpacer />

                                <MudStack Row Spacing="1" AlignItems="AlignItems.Center">
                                    <!-- Copy Button -->
                                    <MudTooltip Text="Copy" Placement="Placement.Top" Delay="250" Arrow>
                                    <MudIconButton
                                            Color="Color.Primary"
                                            Size="Size.Small"
                                            Icon="@Icons.Material.Filled.ContentCopy"
                                            OnClick="CopyAllScannedResultsAsync"
                                            Disabled="@(!scanResultsService.Results.Any())"
                                            />
                                    </MudTooltip>
                                    <!-- Edit Scanned Result Button -->
                                    <MudTooltip Text="Edit" Placement="Placement.Left" Delay="250" Arrow>
                                        <MudIconButton
                                            Icon="@Icons.Material.Filled.Edit"
                                            Color="Color.Primary"
                                            Size="Size.Small"
                                            Disabled="@isSaving"
                                            OnClick="@(() => OpenCategoryEditDialogAsync(barcodeItem))"
                                        />
                                    </MudTooltip>

                                    <!-- Delete Scanned Result Button -->
                                    <MudTooltip Text="Delete" Placement="Placement.Left" Delay="250" Arrow>
                                        <MudIconButton
                                            Icon="@Icons.Material.Filled.Delete"
                                            Color="Color.Error"
                                            Size="Size.Small"
                                            Disabled="@isSaving"
                                            OnClick="@(() => DeleteScannedResultConfirmationAsync(barcodeItem))"
                                        />
                                    </MudTooltip>
                                </MudStack>
                            </MudStack>
                        </MudPaper>
                    }
                }
            </MudStack>
        </MudItem>
    </Body>
</MobileComponentLayout>

@code {
    // Event handler field or subscribes for observing collection changes
    private System.Collections.Specialized.NotifyCollectionChangedEventHandler? _collectionChangedSub;

    // Flag to track whether a save operation is in progress
    private bool isSaving;

    // Event-based refresh is more reliable with BlazorWebView
    private void OnScanReceived(object? sender, ScanBarcodeItemViewModel e) => InvokeAsync(StateHasChanged);

    /// <summary>
    /// This code makes a Blazor component automatically refresh when a data collection changes,
    /// and cleans up the subscription when the component is destroyed.
    /// </summary>
    protected override void OnInitialized()
    {
        // Subscribe to service event (recommended)
        scanResultsService.ScanReceived += OnScanReceived;

        // Create an event handler that triggers a UI re-render on collection changes
        _collectionChangedSub = (_, __) => InvokeAsync(StateHasChanged);
        // Subscribe the handler to the collection's change event
        scanResultsService.Results.CollectionChanged += _collectionChangedSub;
    }

    /// <summary>
    /// Called when the component is disposed (removed from the UI)
    /// Unsubscribes from the collection change event to prevent memory leaks
    /// </summary>
    public void Dispose()
    {
        scanResultsService.ScanReceived -= OnScanReceived;
        if (_collectionChangedSub is not null)
            scanResultsService.Results.CollectionChanged -= _collectionChangedSub;
    }

    /// <summary>
    /// Displays a dialog prompting the user to edit the
    /// current scanned barcode result's category.
    /// </summary>
    private async Task OpenCategoryEditDialogAsync(ScanBarcodeItemViewModel barcodeItem)
    {
        var parameters = new DialogParameters<CategoryEditDialog>
        {
            { x => x.BarcodeItem, barcodeItem }
        };
        var options = new DialogOptions() { CloseButton = true, CloseOnEscapeKey = true, MaxWidth = MaxWidth.ExtraSmall, FullWidth = true };
        var dialog = await DialogService.ShowAsync<CategoryEditDialog>("Edit Category", parameters, options);
        var result = await dialog.Result;

        if (!result.Canceled)
        {
            StateHasChanged();
            Snackbar.Add("Category updated.", Severity.Success);
        }
    }

    /// <summary>
    /// Displays a confirmation dialog asking the user to confirm uploading all the
    /// scanned barcode results.
    /// </summary>
    private async Task SaveScannedResultConfirmationAsync()
    {
        var message = scanResultsService.Results.Count == 1
            ? "Are you sure you want to upload this scanned barcode result?"
            : $"Are you sure you want to upload these {scanResultsService.Results.Count} scanned barcode results?";

        var parameters = new DialogParameters<ConfirmationDialog>
        {
            { x => x.ContentText, message },
            { x => x.SubmitBtnText, "Upload" },
            { x => x.DialogIconColor, Color.Info }
        };
        var options = new DialogOptions() { CloseButton = true, CloseOnEscapeKey = true, MaxWidth = MaxWidth.ExtraSmall, FullWidth = true };
        var dialog = await DialogService.ShowAsync<ConfirmationDialog>("Upload Confirmation", parameters, options);
        var result = await dialog.Result;

        if (!result.Canceled)
        {
            try
            {
                await SaveScannedResultAsync();
            }
            catch
            {
                Snackbar.Add("An unexpected error occurred while uploading the scanned barcode results. Please try again.", Severity.Error);
            }
        }
    }

    /// <summary>
    /// Uploads the current scanned results to the database via IScannedBarcodeService.
    /// Deduplication is handled by the service layer.
    /// </summary>
    private async Task SaveScannedResultAsync()
    {
        if (isSaving || !scanResultsService.Results.Any())
            return;

        isSaving = true;
        try
        {
            // Map to a new list to avoid collection mutation during async call
            var barcodeItems = scanResultsService.Results.ToList();
            if (barcodeItems.Count == 0)
            {
                Snackbar.Add("Nothing to upload.", Severity.Normal);
                return;
            }

            // Short timeout to keep UX snappy on mobile
            using var cts = new CancellationTokenSource(TimeSpan.FromSeconds(30));

            var response = await ScannedBarcodeService.AddScannedBarcodesAsync(barcodeItems, cts.Token);
            if (response.Success)
            {
                Snackbar.Add(response.Message ?? $"{response.Data} barcode(s) uploaded.", Severity.Success);
                scanResultsService.Clear();
            }
            else
            {
                Snackbar.Add(response.Message ?? "Upload failed.", Severity.Error);
            }
        }
        catch (OperationCanceledException)
        {
            Snackbar.Add("Upload cancelled or timed out.", Severity.Warning);
        }
        catch (Exception ex)
        {
            Snackbar.Add($"Upload error: {ex.Message}", Severity.Error);
        }
        finally
        {
            isSaving = false;
            StateHasChanged();
        }
    }

    /// <summary>
    /// Displays a confirmation dialog asking the user to confirm deleting the
    /// current scanned barcode result.
    /// </summary>
    private async Task DeleteScannedResultConfirmationAsync(ScanBarcodeItemViewModel barcodeItem)
    {
        if (isSaving || !scanResultsService.Results.Any())
            return;

        var parameters = new DialogParameters<ConfirmationDialog>
        {
            { x => x.ContentText, "Are you sure you want to delete this scanned result? This action is permanent and cannot be undone." },
            { x => x.SubmitBtnText, "Delete" },
            { x => x.DialogIcon, Icons.Material.Rounded.Warning },
            { x => x.DialogIconColor, Color.Error }
        };
        var options = new DialogOptions() { CloseButton = true, CloseOnEscapeKey = true, MaxWidth = MaxWidth.ExtraSmall, FullWidth = true };
        var dialog = await DialogService.ShowAsync<ConfirmationDialog>("Delete Confirmation", parameters, options);
        var result = await dialog.Result;

        if (!result.Canceled)
        {
            if (scanResultsService.Results.Contains(barcodeItem))
                scanResultsService.Results.Remove(barcodeItem);
        }
    }

    /// <summary>
    /// Displays a confirmation dialog asking the user to confirm clearing all
    /// scanned barcode results currently shown in the list.
    /// </summary> 
    private async Task ClearAllScannedResultConfirmationAsync()
    {
        if (isSaving || !scanResultsService.Results.Any())
            return;

        var parameters = new DialogParameters<ConfirmationDialog>
        {
            { x => x.ContentText, "Are you sure you want to clear all the scanned results? This action is permanent and cannot be undone." },
            { x => x.SubmitBtnText, "Clear" },
            { x => x.DialogIcon, Icons.Material.Rounded.Warning },
            { x => x.DialogIconColor, Color.Error }
        };
        var options = new DialogOptions() { CloseButton = true, CloseOnEscapeKey = true, MaxWidth = MaxWidth.ExtraSmall, FullWidth = true };
        var dialog = await DialogService.ShowAsync<ConfirmationDialog>("Clear All Confirmation", parameters, options);
        var result = await dialog.Result;

        if (!result.Canceled)
            scanResultsService.Clear();
    }
    /// <summary>
    /// Returns barcode results sorted by preferred category order.
    /// Unknown categories are placed at the end.
    /// Results with same category are sorted by scan time.
    /// </summary> 

    private IEnumerable<ScanBarcodeItemViewModel> SortedResults =>
        scanResultsService.Results
            .OrderBy(b => PreferredCategoryOrder.IndexOf(b.Category) >= 0
                ? PreferredCategoryOrder.IndexOf(b.Category)
                : int.MaxValue)
            .ThenBy(b => b.ScannedTime);

    /// <summary>
    /// Defines the desired order for barcode categories.
    /// Used for sorting both display and copy operations.
    /// </summary> 
    private static readonly List<string> PreferredCategoryOrder = new()
    {
        "ASY",
        "ASY-OTL",
        "Serial Number",
        "MAC Address",
        "Deviation",
        "PCA"
    };
    /// <summary>
    /// Copies all sorted barcode results to clipboard.
    /// Uses MAUI Clipboard API and shows feedback via Snackbar.
    /// </summary> 

    private async Task CopyAllScannedResultsAsync()
    {
        if (!scanResultsService.Results.Any())
        {
            Snackbar.Add("No scanned results to copy.", Severity.Warning);
            return;
        }

        var sortedResults = scanResultsService.Results
            .OrderBy(b => PreferredCategoryOrder.IndexOf(b.Category) >= 0
                ? PreferredCategoryOrder.IndexOf(b.Category)
                : int.MaxValue)
            .ThenBy(b => b.ScannedTime)
            .ToList();

        var lines = SortedResults
            .Select(b => $"{b.Value}")
            .ToList();

        var textToCopy = string.Join("\n", lines);

        try
        {
            await Clipboard.Default.SetTextAsync(textToCopy);
            Snackbar.Add("Scanned results copied to clipboard.", Severity.Success);
        }
        catch (Exception ex)
        {
            Snackbar.Add($"Failed to copy: {ex.Message}", Severity.Error);
        }
    }
}