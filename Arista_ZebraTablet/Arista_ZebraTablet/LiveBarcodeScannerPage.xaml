<?xml version="1.0" encoding="utf-8" ?>
<ContentPage
    xmlns="http://schemas.microsoft.com/dotnet/2021/maui"
    xmlns:x="http://schemas.microsoft.com/winfx/2009/xaml"
    xmlns:local="clr-namespace:Arista_ZebraTablet"
    xmlns:components="clr-namespace:Arista_ZebraTablet.Components;assembly=Arista_ZebraTablet"
    xmlns:services="clr-namespace:Arista_ZebraTablet.Services;assembly=Arista_ZebraTablet"
    xmlns:scanner="clr-namespace:BarcodeScanning;assembly=BarcodeScanning.Native.Maui"
    x:Class="Arista_ZebraTablet.LiveBarcodeScannerPage"  
    x:Name="ThisPage"
    BindingContext="{x:Reference ThisPage}"
    Title="Scan Barcodes">

    <Grid RowDefinitions="0.6*,0.4*">
        <AbsoluteLayout Grid.Row="0">
            <Grid AbsoluteLayout.LayoutBounds="0,0,1,1"
                 AbsoluteLayout.LayoutFlags="All">

                <Grid.GestureRecognizers>
                    <PinchGestureRecognizer PinchUpdated="OnPinchUpdated" />
                </Grid.GestureRecognizers>

                <!-- Native Camera & Scanner -->
                <scanner:CameraView x:Name="Camera"
                                    AbsoluteLayout.LayoutBounds="0,0,1,1"
                                    AbsoluteLayout.LayoutFlags="All"
                                    CameraEnabled="False"
                                    TapToFocusEnabled="True"
                                    TorchOn="False"
                                    ViewfinderMode="True"
                                    AimMode="False"
                                    PoolingInterval="250"
                                    OnDetectionFinished="OnDetectionFinished" />
            </Grid>

            <!-- Batch loader overlay (AFTER camera grid & BEFORE closing AbsoluteLayout) -->
            <Grid x:Name="BatchLoader"
                  AbsoluteLayout.LayoutBounds="0,0,1,0.12"  
                  AbsoluteLayout.LayoutFlags="All"
                  IsVisible="{Binding IsDetectionProcessing}"
                  BackgroundColor="#66000000"
                  Padding="10"
                  HorizontalOptions="Fill"
                  VerticalOptions="Start"
                  ZIndex="30"
                  InputTransparent="False">

                <StackLayout Orientation="Horizontal" Spacing="8" HorizontalOptions="Center">
                    <ActivityIndicator IsRunning="True" IsVisible="True" Color="White"/>
                    <Label Text="Processing…" TextColor="White"/>
                    <!-- Keep this simple: no boolean converter needed -->
                    <Label Text="{Binding DetectionProgress, StringFormat=' {0}%'}"
               TextColor="White"/>
                </StackLayout>
            </Grid>

            <!-- Scanning Paused Screen Overlay -->
            <Grid x:Name="PauseOverlay"
                AbsoluteLayout.LayoutBounds="0,0,1,1"
                AbsoluteLayout.LayoutFlags="All"
                IsVisible="False"
                BackgroundColor="#CC1F1F1F"
                InputTransparent="False"
                ZIndex="10"
                >

                <!-- Centered content -->
                <Grid RowDefinitions="Auto,Auto,Auto"
                    RowSpacing="14"
                    HorizontalOptions="Center"
                    VerticalOptions="Center"
                    >
                    <Label Grid.Row="1"
                   Text="Scanning paused"
                   TextColor="White"
                   FontSize="22"
                   FontAttributes="Bold"
                   HorizontalTextAlignment="Center" />
                </Grid>
            </Grid>

            <!-- Bottom Overlay Container that Fills the Camera Controls Area -->
            <Grid AbsoluteLayout.LayoutBounds="0,0,1,1"
                  AbsoluteLayout.LayoutFlags="All"
                  InputTransparent="False"
                  BackgroundColor="Transparent"
                  ZIndex="15">
                <Grid.RowDefinitions>
                    <RowDefinition Height="*" />
                    <RowDefinition Height="Auto" />
                    <RowDefinition Height="Auto" />
                </Grid.RowDefinitions>

                <!-- Camera Controls Anchored at the Bottom -->
                <BlazorWebView x:Name="blazorWebViewCameraControls" Grid.Row="1" BackgroundColor="Transparent" HostPage="wwwroot/index.html">
                    <BlazorWebView.RootComponents>
                        <RootComponent Selector="#app" ComponentType="{x:Type components:BarcodeScannerControls}" />
                    </BlazorWebView.RootComponents>
                </BlazorWebView>
            </Grid>

        </AbsoluteLayout>

        <!-- Results List -->
        <BlazorWebView x:Name="blazorWebViewScannedResult" Grid.Row="1" HostPage="wwwroot/index.html">
            <BlazorWebView.RootComponents>
                <RootComponent Selector="#app" ComponentType="{x:Type components:BarcodeScannerResult}" />
            </BlazorWebView.RootComponents>
        </BlazorWebView>
    </Grid>
</ContentPage>